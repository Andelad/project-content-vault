# Architecture Reference

**Last Updated:** January 9, 2026  
**Architecture:** Pragmatic DDD (4-layer)  
**Tests:** 547 tests via Vitest

---

## Purpose of This Document

This is a **reference guide** to the codebase structure. It answers:
- Where do I find X?
- Where should new code go?
- How are things organized?

**For philosophy and principles:** See `.ddd`  
**For AI quick reference:** See `.cursorrules`

---

## Documentation Map

| Document | Location | Purpose |
|----------|----------|---------|
| `.ddd` | Root | Architectural philosophy & principles |
| `.architecture` | Root | This file - structure reference |
| `.cursorrules` | Root | AI coding rules & patterns |
| `App Logic.md` | `src/domain/` | Domain concepts & entities |
| `Business Rules.md` | `src/domain/` | Business rules & calculations |
| `README.md` | `src/presentation/components/` | Component organization |

---

## Codebase Structure

```
src/
├── domain/                         # Layer 1: Pure business logic
│   ├── App Logic.md                # Domain concepts
│   ├── Business Rules.md           # Business rules & formulas
│   ├── rules/                      # ALL business logic
│   │   ├── __tests__/              # 165 tests
│   │   ├── phases/                 # Phase rules
│   │   ├── projects/               # Project rules
│   │   ├── sync/                   # Cross-cutting sync
│   │   ├── events/                 # Event rules
│   │   ├── availability/           # Capacity & work hours
│   │   ├── clients/                # Client validation
│   │   ├── holidays/               # Holiday calculations
│   │   ├── work-slots/             # Work slot rules
│   │   ├── time-tracking/          # Time tracker logic
│   │   ├── timeline/               # Timeline display rules
│   │   ├── integrity/              # Cross-entity validation
│   │   └── cascade/                # Deletion impact
│   ├── entities/                   # Rich domain models
│   │   ├── __tests__/              # 69 tests
│   │   ├── Project.ts
│   │   ├── Phase.ts
│   │   └── Client.ts
│   └── value-objects/              # Immutable primitives
│       ├── DateRange.ts
│       ├── EmailAddress.ts
│       ├── PhoneNumber.ts
│       └── Color.ts
│
├── application/                    # Layer 2: Use cases & workflows
│   ├── orchestrators/              # Workflows (CREATE/UPDATE/DELETE)
│   │   ├── __tests__/              # 82 tests
│   │   ├── ProjectOrchestrator.ts
│   │   ├── PhaseOrchestrator.ts
│   │   ├── CalendarEventOrchestrator.ts
│   │   └── ...
│   └── queries/                    # Read-side operations
│       ├── ProjectQueries.ts
│       └── EventQueries.ts
│
├── infrastructure/                 # Layer 3: External dependencies
│   ├── database/                   # Supabase client
│   │   └── client.ts
│   ├── errors/                     # Error handling
│   │   └── ErrorHandlingService.ts
│   └── caching/                    # Performance optimization
│
├── presentation/                   # Layer 4: UI (React)
│   ├── components/                 # React UI components
│   │   ├── README.md               # Component guide
│   │   ├── shadcn/                 # Design system (shadcn/ui)
│   │   ├── views/                  # Page-level components
│   │   │   ├── TimelineView.tsx
│   │   │   ├── PlannerView.tsx
│   │   │   └── InsightsView.tsx
│   │   ├── features/               # Feature components
│   │   │   ├── timeline/
│   │   │   ├── planner/
│   │   │   ├── projects/
│   │   │   ├── events/
│   │   │   └── insights/
│   │   ├── shared/                 # Reusable components
│   │   ├── modals/                 # Modal dialogs
│   │   ├── layout/                 # Layout components
│   │   └── debug/                  # Debug components
│   ├── hooks/                      # React hooks
│   │   ├── data/                   # Data fetching hooks
│   │   │   ├── useEvents.ts
│   │   │   ├── useProjects.ts
│   │   │   └── usePhases.ts
│   │   ├── ui/                     # UI logic hooks
│   │   │   ├── useToast.ts
│   │   │   └── useDisclosure.ts
│   │   └── insights/               # Performance optimization
│   │       └── useDebouncedCalculation.ts
│   ├── contexts/                   # React contexts
│   │   ├── AuthContext.tsx         # Authentication
│   │   ├── SettingsContext.tsx     # User preferences
│   │   ├── ProjectContext.tsx      # Project list
│   │   ├── PlannerContext.tsx      # Legacy (being phased out)
│   │   └── TimelineContext.tsx     # Timeline viewport
│   ├── constants/                  # UI constants
│   │   ├── colors.ts
│   │   ├── icons.ts
│   │   └── layout.ts
│   └── pages/                      # Page components
│
├── shared/                         # Cross-cutting concerns
│   ├── types/                      # TypeScript types
│   │   └── core.ts                 # All core types (single source)
│   └── assets/                     # Static files
│       └── icons/
│
└── website/                        # Public marketing pages
    └── pages/
        ├── LandingPage.tsx
        └── Auth.tsx
```

---

## Layer Responsibilities

### Domain Layer (`src/domain/`)

**Purpose:** Pure business logic, completely isolated from UI and infrastructure.

**Contains:**
- `rules/` - ALL business logic (validation, calculations, constraints)
- `entities/` - Rich domain models with behavior
- `value-objects/` - Immutable primitives (DateRange, EmailAddress, etc.)

**Rules:**
- ❌ NO UI references
- ❌ NO database/persistence logic
- ❌ NO external dependencies
- ✅ Pure functions only
- ✅ 100% testable in isolation

**Test Coverage:** ~90% (234 tests)

---

### Application Layer (`src/application/`)

**Purpose:** Coordinates domain logic with infrastructure to fulfill use cases.

**Contains:**
- `orchestrators/` - Workflows (CREATE/UPDATE/DELETE operations)
  - Call domain rules for validation
  - Direct Supabase access (no repository layer)
  - Transform data using mappers
  - Coordinate side effects
- `queries/` - Read-side operations and data aggregation

**Rules:**
- ❌ NO business logic (goes in `domain/rules/`)
- ✅ Call domain rules for validation/calculations
- ✅ Direct Supabase access
- ✅ Transform data for UI

**Test Coverage:** ~75% (82 tests)

---

### Infrastructure Layer (`src/infrastructure/`)

**Purpose:** External dependencies and technical concerns.

**Contains:**
- `database/` - Supabase client configuration
- `errors/` - Error handling (uses dependency injection)
- `caching/` - Performance optimization

**Rules:**
- ❌ NO business logic
- ❌ NO direct imports from presentation (use dependency injection)
- ✅ External integrations
- ✅ Technical cross-cutting concerns

---

### Presentation Layer (`src/presentation/`)

**Purpose:** React components, hooks, and UI-specific logic.

**Contains:**
- `components/` - React UI components
- `hooks/` - React hooks (data fetching + UI logic)
- `contexts/` - React contexts (UI state + scoped data)
- `constants/` - UI constants
- `pages/` - Page components

**Rules:**
- ❌ NO business logic (goes in `domain/rules/`)
- ✅ Components load data via hooks or receive via props
- ✅ Components call orchestrators directly for CRUD
- ✅ Contexts for UI state or scoped data sharing

---

### Shared Layer (`src/shared/`)

**Purpose:** Code used across all layers.

**Contains:**
- `types/core.ts` - ALL core type definitions (single source of truth)
- `assets/` - Static files

**Rules:**
- ❌ NO dependencies on other layers
- ✅ Everything depends on this layer

---

## Quick Decision Matrix

**"Where does this code go?"**

| Code Type | Location | Example |
|-----------|----------|---------|
| Business validation | `domain/rules/` | Phase date validation |
| Business calculation | `domain/rules/` | Budget allocation formula |
| Domain model | `domain/entities/` | Project, Phase, Event |
| Immutable primitive | `domain/value-objects/` | DateRange, EmailAddress |
| Workflow (CRUD) | `application/orchestrators/` | createProject, updatePhase |
| Data aggregation | `application/queries/` | getProjectsWithPhases |
| Database client | `infrastructure/database/` | Supabase config |
| Error handling | `infrastructure/errors/` | ErrorHandlingService |
| React component | `presentation/components/` | ProjectCard, EventModal |
| React hook | `presentation/hooks/` | useEvents, useProjects |
| Global UI state | `presentation/contexts/` | AuthContext, SettingsContext |
| Type definition | `shared/types/core.ts` | Project, Phase interfaces |

---

## Data Loading Patterns

### When to Use Each Pattern

| Pattern | When to Use | Example |
|---------|-------------|---------|
| **Global Context** | Needed everywhere in app | Auth state, user preferences |
| **Parent Loads → Props** | 3-5 children share similar data | InsightsView loads events, cards receive |
| **Scoped Context** | 5+ nested levels need same data | TimelineDataContext for timeline feature |
| **Component Loads** | Component-specific needs | Modal needs different data than view |

### Example: Parent Loads + Props

```typescript
// ✅ Parent loads once, children receive via props
function InsightsView() {
  const { events, isLoading } = useEvents({ startDate, endDate });
  
  if (isLoading) return <LoadingSpinner />;
  
  return (
    <>
      <TimeDistributionCard events={events} />
      <ProjectBreakdownCard events={events} />
      <TrendAnalysisCard events={events} />
    </>
  );
}
```

**Benefits:** Coordinated UX (one loading state), right-sized data, explicit data flow.

---

## Common Workflows

### Adding Business Logic

1. **Document first:** Update `domain/Business Rules.md`
2. **Implement:** Create in `domain/rules/[concept]/`
3. **Test:** Add tests in `domain/rules/__tests__/`
4. **Use:** Call from orchestrators or entities

### Adding a New Feature

1. **Check domain docs:** Does entity/rule exist?
2. **Add domain logic:** If needed (`domain/rules/`, `domain/entities/`)
3. **Create orchestrator:** For workflows (`application/orchestrators/`)
4. **Build UI:** Components (`presentation/components/`)
5. **Update docs:** If domain changed

### Adding a Workflow (CRUD)

1. **Create orchestrator:** `application/orchestrators/[Entity]Orchestrator.ts`
2. **Use domain rules:** Call validation/calculations from `domain/rules/`
3. **Direct DB access:** Call Supabase directly (no repository)
4. **Transform data:** Use mappers if needed
5. **Test:** Add tests in `application/orchestrators/__tests__/`

---

## Type System

### Single Source of Truth

**ALL core types:** `src/shared/types/core.ts`

**Never:**
- ❌ Redefine core types in components
- ❌ Create duplicate interfaces

**OK to:**
- ✅ Extend core types for component props
- ✅ Add temporary UI-specific fields

```typescript
// ✅ Extend for component use
interface LocalProject extends Project {
  isSelected?: boolean;
  isEditing?: boolean;
}

// ❌ Redefine
interface Project { id: string; name: string; } // NO!
```

---

## Dependency Patterns

### Dependency Injection

**Problem:** Infrastructure needs UI dependencies (e.g., toast notifications) but can't import from presentation (circular dependency).

**Solution:** Inject dependencies at app initialization.

```typescript
// infrastructure/errors/ErrorHandlingService.ts
class ErrorHandlingService {
  private static toastFn: ToastFunction | null = null;
  
  static setToastFunction(fn: ToastFunction) {
    this.toastFn = fn;
  }
  
  static showError(message: string) {
    if (this.toastFn) {
      this.toastFn({ title: "Error", description: message });
    }
  }
}

// App.tsx
import { toast } from '@/presentation/hooks/ui/use-toast';
ErrorHandlingService.setToastFunction(toast);
```

---

## Import Aliases

Path aliases configured in `vite.config.ts` and `tsconfig.json`:

```typescript
import { Project } from '@/shared/types/core';
import { ProjectValidation } from '@/domain/rules/projects/ProjectValidation';
import { ProjectOrchestrator } from '@/application/orchestrators/ProjectOrchestrator';
import { supabase } from '@/infrastructure/database/client';
import { ProjectCard } from '@/presentation/components/features/projects/ProjectCard';
import { useProjects } from '@/presentation/hooks/data/useProjects';
```

**Pattern:** `@/[layer]/[...path]`

---

## Testing Strategy

### Test Coverage by Layer

| Layer | Coverage | Tests | Focus |
|-------|----------|-------|-------|
| Domain Rules | ~90% | 165 | Pure business logic (critical) |
| Domain Entities | ~60% | 69 | Entity behavior |
| Orchestrators | ~75% | 82 | Workflow integration |
| Infrastructure | Minimal | - | Integration points only |
| Hooks/Components | Deferred | - | Not tested during development |

**Total:** 547 tests passing ✅

**Philosophy:** Focus testing on domain layer (pure, critical, easy to test). Defer UI testing until patterns stabilize.

---

## Documentation Updates

### Update Domain Docs When:

- ✅ Entity definitions change
- ✅ Business rules change
- ✅ Calculations/formulas change
- ✅ Relationships between entities change

### Don't Update For:

- ❌ Bug fixes
- ❌ Performance optimizations
- ❌ Refactoring (same behavior)
- ❌ Test additions
- ❌ UI styling changes

### Update This File When:

- Adding new layers or directories
- Changing architectural patterns
- Significant restructuring
- New import patterns

---

## Key Architectural Decisions

### 1. No Repository Layer

Supabase provides type-safe queries and RLS. Repositories would create wrapper methods with no added value. Orchestrators call Supabase directly.

### 2. Calculations Inline with Business Rules

Math calculations live inline with the business logic that uses them. Only extract when used in 3+ domain concepts.

### 3. Direct Supabase Access

Orchestrators make direct Supabase calls. Pragmatic approach - avoids wrapper layer while maintaining clean separation.

### 4. Minimal Contexts

Contexts for global UI state or scoped data sharing (5+ levels deep). Prefer parent loading + props for view-scoped shared data.

### 5. Website Separated from App

Public marketing pages in `/website` separate from authenticated app code. Different concerns, independent deployment.

---

## Further Reading

- **Philosophy & principles:** `.ddd`
- **AI coding rules:** `.cursorrules`
- **Domain concepts:** `src/domain/App Logic.md`
- **Business rules:** `src/domain/Business Rules.md`
- **Component organization:** `src/presentation/components/README.md`
- **Testing guide:** `docs/operations/TESTING_GUIDE.md`
