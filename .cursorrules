# ðŸš¨ AI Development Guide

> **Note:** This file is named `.cursorrules` for compatibility with AI development tools that auto-detect it. It applies to ALL AI assistants (Cursor, Copilot, Claude, etc.), not just Cursor IDE.

> **Philosophy:** "Find existing, extend existing, create new only when necessary"

---

## ðŸ“š DOCUMENTATION GUIDE

**Core Documents:**
- **`.architecture.md`** (root) - WHERE code goes, structural patterns
- **`Domain Logic.md`** (`/src/domain/`) - WHAT entities are (concepts)
- **`Rules Logic.md`** (`/src/domain/`) - HOW calculations work (formulas)
- **`Display Logic.md`** (`/src/domain/`) - Display constraints & view rules
- **`README.md`** (`/src/components/`) - Component organization

**Quick Navigation:**
- Domain concepts â†’ `/src/domain/Domain Logic.md`
- Calculations/formulas â†’ `/src/domain/Rules Logic.md`
- Display constraints â†’ `/src/domain/Display Logic.md`
- Code structure â†’ `/.architecture.md`
- Component files â†’ `/src/components/README.md`

---

## 1. QUICK REFERENCE

### Never Create
- âŒ `/helpers/` directories
- âŒ Business logic in `/utils/` or components
- âŒ Calculations in components
- âŒ Duplicate types (use `/types/core.ts`)
- âŒ Manual date math
- âŒ Validator wrapper files (call domain rules directly)
- âŒ Repository wrapper files (call Supabase directly, except `timeTrackingRepository`)
- âŒ Domain/business logic in orchestrators (put in `domain/rules/`)

### Always Use
- âœ… Import from `@/services` only
- âœ… Types from `/types/core.ts`
- âœ… Domain rules from `/domain/rules/` for validation & business logic
- âœ… Domain entities from `/domain/entities/` when available
- âœ… `dateCalculations.ts` for all date operations
- âœ… `ErrorHandlingService` for all errors
- âœ… Find existing unified services first
- âœ… Delegation pattern in unified services

### Before Writing Code
```bash
grep -r "functionName" src/services/
ls src/services/unified/ | grep -i "domain"
```

---

## 2. CODE ORGANIZATION

**Architecture: Hybrid DDD** (see `.architecture.md` for details)

| Code Type | Location | Purity | Example |
|-----------|----------|--------|---------|
| **Domain Rules** | `/domain/rules/*Rules` | 100% pure (no UI/DB) | Validation, business logic |
| **Domain Entities** | `/domain/entities/*` | 100% pure (no UI/DB) | Rich objects with business methods |
| **Orchestrators** | `/services/orchestrators/*Orchestrator` | Mixed (by design) | Workflows: validation + DB + UI prep |
| **Unified Services** | `/services/unified/Unified*Service` | Pure calculations | Business calculations |
| **UI Components** | `/components` | UI only | Call services, no logic |
| Date Math | `/services/calculations/general/dateCalculations` | Pure math | `normalizeToMidnight()` |
| Error Handling | `ErrorHandlingService` | Infrastructure | Structured logging |
| React State | `/hooks/use*.ts` | Coordination | State + service calls |
| Generic Utils | `/utils` or `/lib` | Pure helpers | `cn()`, `formatCurrency()` |

**Orchestrator Scope (Hybrid DDD - Mixed by Design):**
- âœ… Call domain rules (`ProjectRules.validate()`)
- âœ… Call Supabase directly (no repository layer)
- âœ… Transform data for database
- âœ… Enrich data for UI display
- âœ… Coordinate workflows & side effects
- âŒ NEVER implement business rules (use `domain/rules/`)
- âŒ NEVER implement calculations (use `unified/` services)

---

## 3. PATTERNS

### Orchestrators (workflows)
```typescript
// âœ… Orchestrators coordinate & mix concerns (by design)
export class ProjectOrchestrator {
  static async executeProjectCreationWorkflow(request, context) {
    // âœ… Call domain rules (pure validation)
    const validation = ProjectRules.validateProjectDates(request.startDate, request.endDate);
    if (!validation.isValid) return { success: false, errors: validation.errors };
    
    // âœ… Transform for DB (allowed)
    const prepared = this.transformForDatabase(request);
    
    // âœ… Direct Supabase (no repository layer)
    const { data, error } = await supabase.from('projects').insert(prepared).select().single();
    
    // âœ… Enrich for UI (allowed)
    return this.enrichForDisplay(data);
  }
  
  // âŒ FORBIDDEN - business logic belongs in domain/rules/
  // private calculateRemainingHours() { ... }
}
```

### Unified Services (calculations)
```typescript
// âœ… Always delegate to domain layer
export class UnifiedProjectService {
  static calculateDuration(project: Project): number {
    return DateCalculations.calculateProjectDuration(project);
  }
}
```

### Dates
```typescript
// âœ… Use dateCalculations
import { normalizeToMidnight, addDaysToDate } from '@/services';

// âŒ Never manual
date.setHours(0, 0, 0, 0);
new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
```

### Error Handling
```typescript
// âœ… Use ErrorHandlingService
ErrorHandlingService.handle(error, {
  source: 'ProjectModal',
  action: 'saveProject',
  metadata: { projectId: project.id }
}, { showToast: true });

// âŒ Never
console.error('Error:', error);
```

### Types
```typescript
// âœ… Extend core.ts
import { Project } from '@/types/core';
interface LocalProject extends Project { temp?: boolean; }

// âŒ Never redefine
interface Project { id: string; }
```

---

## 5. BUSINESS LOGIC CHANGES

When modifying business rules:

1. **Update `/src/domain/Domain Logic.md`** (entity definitions, concepts)
2. **Update `/src/domain/Rules Logic.md`** (detailed rules, calculations)
3. **Update `/src/domain/Display Logic.md`** (if display rules changed)
4. **Update `src/domain/rules/*.ts`** (with `@see` references)
5. **Update orchestrators** (workflows using the rule)
6. **Update tests**
7. **Commit with `logic:` prefix**

### What Requires Doc Updates
âœ… Validation rules, calculations, entities, relationships, UI display constraints

### What Doesn't
âŒ Bug fixes, refactoring, tests, performance optimizations

---

## 6. DOCUMENTATION

| Folder | Purpose | Action |
|--------|---------|--------|
| `/src/domain/` | Domain docs (3 files) | UPDATE existing only |
| `/docs/features/[name]/` | Feature docs | Permanent |
| `/docs/operations/` | Testing, deployment | Permanent |
| `/docs/sessions/` | **TEMPORARY** | AI working docs |

### AI Rules
1. âŒ Don't create docs in `/docs/` root or `/docs/features/`
2. âœ… Create temporary docs in `/docs/sessions/`
3. âœ… Update existing domain docs when logic changes
4. âœ… Remind user to delete `/docs/sessions/` files when done

---

## 7. HOOKS

### When to Create
- Managing React state with service coordination
- Handling DOM events (drag, scroll, resize)
- Coordinating services with React lifecycle
- Cleaning up side effects

### Never Put in Hooks
- âŒ Business logic â†’ `domain/rules`
- âŒ Calculations â†’ `services/unified`
- âŒ Workflows â†’ `services/orchestrators`
- âŒ Database operations â†’ orchestrators

> **Note:** Creating hooks does NOT require changing existing services. Services remain pure and stateless.

### Pattern
```typescript
// âœ… Hook coordinates services + manages state
export function useProjectDrag(config) {
  const [isDragging, setIsDragging] = useState(false);
  
  const handleMouseDown = useCallback((e, projectId) => {
    const result = TimelineDragCoordinatorService.coordinateDragOperation(dragState, e);
    setDragState(result.newDragState);
  }, [config]);
  
  return { isDragging, handleMouseDown };
}
```

---

## 9. CHECKLIST

Before committing:
- [ ] Checked for existing similar code? (`grep -r`)
- [ ] Importing from `@/services`?
- [ ] Using `core.ts` types?
- [ ] Using `dateCalculations` for dates?
- [ ] Using `ErrorHandlingService` for errors?
- [ ] Domain rules in `domain/rules/`, not orchestrators?
- [ ] Orchestrators coordinate only (no business logic)?
- [ ] Business logic in services, not components?
- [ ] If domain logic changed: updated Domain Logic.md + Rules Logic.md?
- [ ] If UI constraint changed: updated Display Logic.md?
- [ ] Commit message has correct prefix?
