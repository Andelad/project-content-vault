# AI Development Guide

> **Philosophy:** "Find existing, extend existing, create new only when necessary"

---

## ARCHITECTURE - 4-Layer DDD

**Current State:** Pragmatic DDD ✅ Implemented  
**Tests:** 547 tests via Vitest

```
src/
├── domain/                 ← Pure business logic
│   ├── rules/              ← ALL business logic + __tests__/
│   ├── entities/           ← Rich models + __tests__/
│   └── value-objects/      ← Immutable primitives
├── application/            ← Use cases
│   ├── orchestrators/      ← Workflows + __tests__/
│   └── queries/            ← Read operations
├── infrastructure/         ← External dependencies
│   ├── database/           ← Supabase client
│   ├── errors/             ← Error handling
│   └── caching/            ← Performance
├── presentation/           ← UI layer
│   ├── components/         ← React UI
│   ├── hooks/              ← React hooks
│   ├── contexts/           ← React contexts
│   └── pages/              ← Page components
├── shared/                 ← Cross-cutting
│   └── types/core.ts       ← ALL core types
└── website/                ← Public pages
```

**For details:** See `.ddd` (philosophy), `.architecture` (structure)

---

## QUICK REFERENCE

### Never Create
- ❌ Business logic in components/hooks/orchestrators
- ❌ Separate MathUtils (keep inline with business logic)
- ❌ Repository layer (direct Supabase access)
- ❌ Test files outside `__tests__/`
- ❌ New root-level directories

### Always Use
- ✅ Import from `@/{layer}/...` path aliases
- ✅ Types from `@/shared/types/core`
- ✅ Domain rules from `@/domain/rules/`
- ✅ `ErrorHandlingService` for errors
- ✅ Co-located tests in `__tests__/`

### Before Writing Code
```bash
grep -r "functionName" src/domain/rules/
grep -r "functionName" src/application/
grep -r "functionName" src/presentation/
```

---

## CODE PLACEMENT

| Code Type | Location | Example |
|-----------|----------|---------|
| Business validation | `domain/rules/{concept}/` | Phase date validation |
| Business calculation | `domain/rules/{concept}/` | Budget allocation (inline math) |
| Domain model | `domain/entities/` | Project, Phase, Client |
| Immutable primitive | `domain/value-objects/` | DateRange, EmailAddress |
| Workflow (CRUD) | `application/orchestrators/` | createProject, updatePhase |
| Data query | `application/queries/` | getProjectsWithPhases |
| Database client | `infrastructure/database/` | Supabase config |
| Error handling | `infrastructure/errors/` | ErrorHandlingService |
| React component | `presentation/components/` | ProjectCard, EventModal |
| React hook | `presentation/hooks/` | useEvents, useProjects |
| Context (UI state) | `presentation/contexts/` | AuthContext, SettingsContext |
| Type definition | `shared/types/core.ts` | Project, Phase interfaces |

---

## PATTERNS

### Domain Rules (Pure Business Logic)
```typescript
// ✅ 100% pure - no UI, no DB, no side effects
// Calculations INLINE (no separate utilities)
export class ProjectBudget {
  static validateAllocation(phases: Phase[], total: number): ValidationResult {
    // Inline math calculation
    const allocated = phases.reduce((sum, p) => sum + p.budget, 0);
    
    if (allocated > total) {
      return { isValid: false, errors: ['Over budget'] };
    }
    
    return { isValid: true };
  }
}
```

### Orchestrators (Workflows - Pragmatic)
```typescript
// ✅ Mix concerns intentionally - call domain rules, DB, transform
export class ProjectOrchestrator {
  static async createProject(input: CreateProjectInput) {
    // 1. Domain validation
    const validation = ProjectValidation.validate(input);
    if (!validation.isValid) return validation;
    
    // 2. Direct Supabase (no repository)
    const { data } = await supabase.from('projects').insert(input).select().single();
    
    // 3. Return (transform if needed)
    return { success: true, data };
  }
}

// ❌ NEVER put business logic here
// static calculateBudget() { ... } // Goes in domain/rules/
```

### Data Loading (Context vs Props vs Component)

**Use Context For:**
```typescript
// ✅ Global UI state needed everywhere
const AuthContext = { user, login, logout };
const SettingsContext = { theme, timezone };
```

**Use Parent Loads + Props For:**
```typescript
// ✅ View-scoped shared data (coordinated loading)
function InsightsView() {
  const { events, isLoading } = useEvents({ startDate, endDate });
  
  if (isLoading) return <LoadingSpinner />;
  
  return (
    <>
      <TimeDistributionCard events={events} />
      <ProjectBreakdownCard events={events} />
    </>
  );
}
```

**Use Component Loads For:**
```typescript
// ✅ Component-specific data needs
function ProjectModal({ projectId }) {
  const { project } = useProject(projectId);
  // This modal needs different data than parent view
}
```

**Decision:**
- Needed everywhere → Global Context
- 3-5 children share similar data → Parent loads, pass props
- 5+ nested levels → Scoped Context
- Component-specific → Component loads

### Error Handling
```typescript
// ✅ Use ErrorHandlingService
ErrorHandlingService.handle(error, {
  source: 'ProjectModal',
  action: 'saveProject'
}, { showToast: true });

// ❌ Never
console.error('Error:', error);
```

### Types
```typescript
// ✅ Extend from core.ts
import { Project } from '@/shared/types/core';
interface LocalProject extends Project { isSelected?: boolean; }

// ❌ Never redefine
interface Project { id: string; } // NO!
```

### Dependency Injection
```typescript
// Infrastructure can't import presentation (circular dependency)
// Inject at app initialization

// App.tsx
import { toast } from '@/presentation/hooks/ui/use-toast';
ErrorHandlingService.setToastFunction(toast);
```

---

## BUSINESS LOGIC CHANGES

When modifying business rules:

1. **Update domain docs:**
   - `domain/App Logic.md` - Entity definitions
   - `domain/Business Rules.md` - Formulas, calculations
2. **Update code:** `domain/rules/{concept}/`
3. **Update tests:** `domain/rules/__tests__/`
4. **Update orchestrators** if workflow changed
5. **Commit:** `logic: description`

**What requires doc updates:**
- ✅ Validation rules, calculations, entities, relationships

**What doesn't:**
- ❌ Bug fixes, refactoring, performance, UI changes

---

## BUG FIX PROCESS

**See `.bug` for detailed bug fix guide.**

**Quick version:**
1. Investigate (grep searches) - DON'T fix yet
2. Summarize & offer solutions - Wait for feedback
3. Fix priority: domain → application → presentation
4. Add regression test

---

## DOCUMENTATION

| Document | Purpose |
|----------|---------|
| `.ddd` | Architectural philosophy & principles |
| `.architecture` | Structure reference & workflows |
| `.cursorrules` | This file - AI quick reference |
| `domain/App Logic.md` | Domain concepts & entities |
| `domain/Business Rules.md` | Business rules & formulas |
| `presentation/components/README.md` | Component organization |

**AI Rules:**
- ❌ Don't create docs in `/docs/` root
- ✅ Create temporary docs in `/docs/sessions/`
- ✅ Update domain docs when logic changes
- ✅ Remind user to delete temp docs when done

---

## KEY DECISIONS

1. **No Repository Layer** - Direct Supabase access (type-safe, has RLS)
2. **Calculations Inline** - Math with business logic (not separate utils)
3. **Dependency Injection** - Infrastructure uses DI for UI dependencies
4. **Minimal Contexts** - UI state or scoped data, not global data loading
5. **Website Separate** - Public pages separate from app infrastructure

---

## CHECKLIST

Before committing:
- [ ] Checked for existing code? (`grep -r`)
- [ ] Pure domain logic in `domain/rules/`?
- [ ] Orchestrators coordinate only (no business logic)?
- [ ] Data loading pattern correct? (Context/Props/Component)
- [ ] Logic change? Updated domain docs?
- [ ] New domain rule/orchestrator? Wrote test?
- [ ] Correct commit prefix?
