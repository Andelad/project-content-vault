# üö® AI Development Guide

> **Note:** This file is named `.cursorrules` for compatibility with AI development tools that auto-detect it. It applies to ALL AI assistants (Cursor, Copilot, Claude, etc.), not just Cursor IDE.

> **Philosophy:** "Find existing, extend existing, create new only when necessary"

---

## ‚úÖ ARCHITECTURE - THREE LAYERS COMPLETE

**Current State:** Three-layer architecture ‚úÖ SUBSTANTIALLY COMPLETE  
**Tests:** 547 tests via Vitest (co-located `__tests__/` dirs)

**Architecture:**
```
domain/rules/        ‚Üê ALL business logic + __tests__/
domain/entities/     ‚Üê Rich models + __tests__/
services/orchestrators/ ‚Üê Workflows + __tests__/
services/data/       ‚Üê Mappers & aggregators
services/infrastructure/ ‚Üê Errors, storage, caching
services/ui/         ‚Üê View positioning
components/          ‚Üê React UI (shadcn/, features/, views/)
hooks/               ‚Üê React hooks (NOT tested - deferred)
utils/               ‚Üê Generic helpers + __tests__/
```

**Code Placement:**
- Business logic ‚Üí `domain/rules/{concern}/`
- Workflows ‚Üí `services/orchestrators/`
- Data transform ‚Üí `services/data/`
- View positioning ‚Üí `services/ui/`
- Tests ‚Üí `__tests__/{SourceFile}.test.ts` (co-located)

---

## ÔøΩüìö DOCUMENTATION GUIDE

**Core Documents:**
- **`.ddd`** (root) - Hybrid DDD philosophy & architecture evolution
- **`.architecture`** (root) - WHERE code goes, structural patterns
- **`App Logic.md`** (`/src/domain/`) - WHAT entities are (concepts)
- **`Business Rules.md`** (`/src/domain/`) - HOW calculations work (formulas)
- **`Display Logic.md`** (`/src/services/ui/`) - Display constraints & view rules
- **`README.md`** (`/src/components/`) - Component organization

**Quick Navigation:**
- Domain concepts ‚Üí `/src/domain/App Logic.md`
- Calculations/formulas ‚Üí `/src/domain/Business Rules.md`
- Display constraints ‚Üí `/src/services/ui/Display Logic.md`
- Code structure ‚Üí `/.architecture`
- Hybrid DDD philosophy ‚Üí `/.ddd`
- Component files ‚Üí `/src/components/README.md`

---

## 1. QUICK REFERENCE

### Never Create
- ‚ùå `/helpers/` directories
- ‚ùå Business logic in `/utils/` or components
- ‚ùå Separate MathUtils files (keep inline)
- ‚ùå Domain/business logic in orchestrators
- ‚ùå New folders in `/src` root
- ‚ùå Test files outside `__tests__/`

### Always Use
- ‚úÖ Import from `@/services` only
- ‚úÖ Types from `/types/core.ts`
- ‚úÖ Domain rules from `/domain/rules/`
- ‚úÖ `ErrorHandlingService` for all errors
- ‚úÖ Co-locate tests in `__tests__/` dirs
- ‚úÖ Vitest for tests (not Jest)

### Before Writing Code
```bash
grep -r "functionName" src/domain/rules/
grep -r "functionName" src/services/
```

### Bug Fix Process
```bash
# 1. Find the business logic
grep -r "relevantConcept" src/domain/rules/

# 2. Check existing tests (shows expected behavior)
grep -r "describe.*relevantConcept" src/**/__tests__/

# 3. Read test to understand what SHOULD happen

# 4. Fix domain rule OR orchestrator OR component (in that priority order)

# 5. Add regression test for this specific bug case

# 6. Run tests
npm test -- FileName
```

**Priority order for fixes:**
1. Domain rule bug? ‚Üí Fix in `domain/rules/` + add test
2. Workflow bug? ‚Üí Fix in `services/orchestrators/` + add test  
3. UI bug? ‚Üí Fix in `components/` (tests optional)

---

## 2. CODE ORGANIZATION

**Architecture: Hybrid DDD - Three Layers** (see `.ddd` for philosophy)

| Code Type | Location | Purity | Example |
|-----------|----------|--------|---------|
| **Domain Rules** | `/domain/rules/*` | 100% pure (no UI/DB) | Validation + calculations (inline) |
| **Domain Entities** | `/domain/entities/*` | 100% pure (no UI/DB) | Rich objects with business methods |
| **Value Objects** | `/domain/value-objects/*` | 100% pure | DateRange, EmailAddress |
| **Orchestrators** | `/services/orchestrators/*Orchestrator` | Mixed (by design) | Workflows: validation + DB + UI prep |
| **Data Mappers** | `/services/data/mappers/*` | Pure transformation | DB‚ÜîUI field translation |
| **Data Aggregators** | `/services/data/aggregators/*` | Queries only | Multi-table queries + rollups |
| **Infrastructure** | `/services/infrastructure/*` | Cross-cutting | ErrorHandlingService, caching |
| **UI Services** | `/services/ui/*` | View-specific | Positioning, layout calculations |
| **UI Components** | `/components/shadcn/*` | Primitives | Design system (shadcn/ui) |
| **UI Components** | `/components/features/*` | Feature-specific | Timeline, Planner, Projects |
| Date Math | `/utils/dateCalculations.ts` | Pure math | `normalizeToMidnight()` |
| React State | `/hooks/{concern}/` | Coordination | State + service calls |
| Generic Utils | `/utils` or `/lib` | Pure helpers | `cn()`, `formatCurrency()` |

**Orchestrator Scope (Hybrid DDD - Mixed by Design):**
- ‚úÖ Call domain rules (`PhaseValidation.validate()`, `DateSync.synchronize()`)
- ‚úÖ Call Supabase directly (no repository layer)
- ‚úÖ Use data mappers for DB transformation
- ‚úÖ Enrich data for UI display
- ‚úÖ Coordinate workflows & side effects
- ‚ùå NEVER implement business rules (use `domain/rules/`)
- ‚ùå NEVER implement calculations (put in `domain/rules/` inline)

---

## 3. PATTERNS

### Orchestrators (workflows)
```typescript
// ‚úÖ Orchestrators coordinate & mix concerns (by design)
export class ProjectOrchestrator {
  static async executeProjectCreationWorkflow(request, context) {
    // ‚úÖ Call domain rules (pure validation + calculations)
    const validation = ProjectValidation.validateProjectDates(request.startDate, request.endDate);
    if (!validation.isValid) return { success: false, errors: validation.errors };
    
    // ‚úÖ Transform for DB (allowed)
    const prepared = this.transformForDatabase(request);
    
    // ‚úÖ Direct Supabase (no repository layer)
    const { data, error } = await supabase.from('projects').insert(prepared).select().single();
    
    // ‚úÖ Enrich for UI (allowed)
    return this.enrichForDisplay(data);
  }
  
  // ‚ùå FORBIDDEN - business logic belongs in domain/rules/
  // private calculateRemainingHours() { ... }
}
```

### Domain Rules (ALL business logic goes here)
```typescript
// ‚úÖ Pure domain logic with calculations INLINE (no DB, no UI, no side effects)
// Located in domain/rules/{concern}/
export class PhaseRecurrence {
  static generateOccurrences(config: RecurringConfig, range: DateRange): Date[] {
    // Pure RRule-based logic, 100% testable
    // Calculations inline - no separate MathUtils
  }
  
  static validateRecurringConfig(config: RecurringConfig): ValidationResult {
    // Pure validation logic
  }
}

// ‚úÖ Cross-cutting concerns in domain/rules/sync/
export class DateSync {
  static synchronizeProjectWithPhases(project: Project, phases: Phase[]): SyncResult {
    // Inline date calculations - no external math utilities
    const earliestStart = phases.reduce((earliest, phase) => {
      const start = new Date(phase.startDate);
      return !earliest || start < earliest ? start : earliest;
    }, null as Date | null);
    
    return { updatedProject: { ...project, startDate: earliestStart } };
  }
}
```

### Data Services (transformation only - NO business logic)
```typescript
// ‚úÖ Pure data transformation (DB‚ÜîUI)
// Located in services/data/mappers/
export const PhaseMapper = {
  fromDatabase(row: DatabaseMilestone): PhaseDTO {
    return {
      id: row.id,
      endDate: new Date(row.due_date), // Field translation
    };
  },
  toDatabase(phase: PhaseDTO): Partial<DatabaseMilestone> {
    return {
      due_date: phase.endDate.toISOString(), // Reverse translation
    };
  }
};

// ‚úÖ Multi-table queries (NO business logic)
// Located in services/data/aggregators/
export class PhaseAggregator {
  static async getPhasesWithTimeEntries(projectId: string) {
    // Pure data aggregation - no business rules
  }
}
```

### ‚ö†Ô∏è Legacy Patterns (Being Migrated)
```typescript
// ‚ö†Ô∏è LEGACY: domain-services/ ‚Üí merging into domain/rules/
export class PhaseRecurrenceService { ... } // ‚Üí domain/rules/phases/PhaseRecurrence.ts

// ‚ö†Ô∏è LEGACY: unified/ ‚Üí splitting into domain/rules/ + services/data/
export class UnifiedProjectService { ... } // Business logic ‚Üí domain/rules/, data ‚Üí services/data/
```

### Dates
```typescript
// ‚úÖ Use dateCalculations for generic operations
import { normalizeToMidnight, addDaysToDate } from '@/services';

// ‚úÖ Inline simple date math in domain rules when business-specific
const daysDiff = Math.ceil((end.getTime() - start.getTime()) / (1000 * 60 * 60 * 24));

// ‚ùå Never manual date math in components or orchestrators
date.setHours(0, 0, 0, 0);
```

### Error Handling
```typescript
// ‚úÖ Use ErrorHandlingService
ErrorHandlingService.handle(error, {
  source: 'ProjectModal',
  action: 'saveProject',
  metadata: { projectId: project.id }
}, { showToast: true });

// ‚ùå Never
console.error('Error:', error);
```

### Types
```typescript
// ‚úÖ Extend core.ts
import { Project } from '@/types/core';
interface LocalProject extends Project { temp?: boolean; }

// ‚ùå Never redefine
interface Project { id: string; }
```

---

## 5. BUSINESS LOGIC CHANGES

When modifying business rules:

1. **Update `/src/domain/App Logic.md`** (entity definitions, concepts)
2. **Update `/src/domain/Business Rules.md`** (detailed rules, calculations)
3. **Update `/src/services/ui/Display Logic.md`** (if display rules changed)
4. **Update `src/domain/rules/*.ts`** (with `@see` references)
5. **Update orchestrators** (workflows using the rule)
6. **Update tests** (`__tests__/{SourceFile}.test.ts`)
7. **Commit with `logic:` prefix**

### What Requires Doc Updates
‚úÖ Validation rules, calculations, entities, relationships, UI display constraints

### What Doesn't
‚ùå Bug fixes, refactoring, tests, performance optimizations

---

## 6. DOCUMENTATION

| Folder | Purpose | Action |
|--------|---------|--------|
| `/src/domain/` | Domain docs (3 files) | UPDATE existing only |
| `/docs/operations/` | Testing, deployment | Permanent |
| `/docs/sessions/` | **TEMPORARY** | AI working docs |

### AI Rules
1. ‚ùå Don't create docs in `/docs/` root or `/docs/features/`
2. ‚úÖ Create temporary docs in `/docs/sessions/`
3. ‚úÖ Update existing domain docs when logic changes
4. ‚úÖ Remind user to delete `/docs/sessions/` files when done

---

## 7. HOOKS

- Managing React state + service coordination
- NO business logic, workflows, or DB operations
- NOT tested during active development

---

## 8. CHECKLIST

Before committing:
- [ ] Checked for existing code? (`grep -r`)
- [ ] Pure domain logic in `domain/rules/`?
- [ ] Orchestrators coordinate only (no business logic)?
- [ ] If logic changed: updated App Logic.md + Business Rules.md?
- [ ] If new domain rule/orchestrator: wrote test?
- [ ] Commit message has correct prefix?
