# üö® AI Development Guide

> **Note:** This file is named `.cursorrules` for compatibility with AI development tools that auto-detect it. It applies to ALL AI assistants (Cursor, Copilot, Claude, etc.), not just Cursor IDE.

> **Philosophy:** "Find existing, extend existing, create new only when necessary"

---

## üìö DOCUMENTATION GUIDE

| Document | When to Read | Contains |
|----------|--------------|----------|
| **`docs/core/App Logic.md`** | Understanding WHAT things are | Entity definitions, time concepts, workflows, validation rules |
| **`docs/core/Business Logic.md`** | Understanding HOW things behave | Detailed rules, calculations, edge cases, state transitions, TypeScript interfaces |
| **`docs/core/Architecture Guide.md`** | Understanding WHERE code goes | Code structure, patterns, service organization |

**Quick Reference:**
- "What is a Phase?" ‚Üí App Logic.md
- "How do auto-estimates calculate?" ‚Üí Business Logic.md
- "Where should I put this code?" ‚Üí Architecture Guide.md

**Document Ownership:**

| Concept | Owner |
|---------|-------|
| Entity definitions | App Logic.md |
| Time concepts | App Logic.md |
| Business rules | App Logic.md (concepts) + Business Logic.md (implementation) |
| **UI Features** | **Code itself (`src/components/features/`)** |
| Code structure | Architecture Guide.md |

**Building Features:**
1. Read App Logic.md for WHAT to show
2. Read Business Logic.md for HOW to calculate
3. Explore `src/components/features/` for patterns
4. Build using established patterns

> **Philosophy:** Logic is stable (document it). UI is fluid (code is the doc).

---

## 1. QUICK REFERENCE

### Never Create
- ‚ùå `/helpers/` directories
- ‚ùå Business logic in `/utils/`
- ‚ùå Calculations in components
- ‚ùå Duplicate types (use `/types/core.ts`)
- ‚ùå Manual date math
- ‚ùå Validator wrappers (call domain rules directly)
- ‚ùå Repository wrappers (call Supabase directly, except `timeTrackingRepository`)

### Always Use
- ‚úÖ Import from `@/services` only
- ‚úÖ Types from `/types/core.ts`
- ‚úÖ `dateCalculations.ts` for all date operations
- ‚úÖ `ErrorHandlingService` for all errors
- ‚úÖ Find existing unified services first
- ‚úÖ Delegation pattern in unified services
- ‚úÖ Typography: update BOTH `index.css` AND `tailwind.config.ts`

### Before Writing Code
```bash
grep -r "functionName" src/services/
ls src/services/unified/ | grep -i "domain"
```

---

## 2. CODE ORGANIZATION

| Code Type | Location | Example |
|-----------|----------|---------|
| UI | `/components` | Call services, no logic |
| Workflows | `/services/orchestrators/*Orchestrator` | CREATE/UPDATE/DELETE |
| Calculations | `/services/unified/Unified*Service` | READ/TRANSFORM |
| Business Rules | `/domain/rules/*Rules` | Single source of truth |
| Date Math | `/services/calculations/general/dateCalculations` | `normalizeToMidnight()` |
| Error Handling | `ErrorHandlingService` | Structured logging |
| React State | `/hooks/use*.ts` | State + service calls |
| Generic Utils | `/utils` or `/lib` | `cn()`, `formatCurrency()` |

---

## 3. DEVELOPMENT WORKFLOW (VS Code ‚Üî Lovable ‚Üî Supabase)

| Tool | Purpose |
|------|---------|
| **VS Code** | TypeScript, React, business logic |
| **Lovable** | Database migrations, Supabase schema |
| **GitHub** | Sync point between both |

### For Database Changes
1. ‚ùå **DO NOT** run SQL migrations directly
2. ‚úÖ Create `INSTRUCTIONS_FOR_LOVABLE_[FEATURE].md` in project root
3. ‚úÖ Include SQL, purpose, and verification steps
4. ‚úÖ Push to GitHub for Lovable to execute

---

## 4. PATTERNS

### Orchestrators (workflows)
```typescript
// ‚úÖ Call domain rules + Supabase directly
export class ProjectOrchestrator {
  static async executeProjectCreationWorkflow(request, context) {
    const validation = ProjectRules.validateProjectDates(request.startDate, request.endDate);
    if (!validation.isValid) return { success: false, errors: validation.errors };
    
    const { data, error } = await supabase.from('projects').insert(prepared).select().single();
    return this.transformFromDatabase(data);
  }
}
```

### Unified Services (calculations)
```typescript
// ‚úÖ Always delegate to domain layer
export class UnifiedProjectService {
  static calculateDuration(project: Project): number {
    return DateCalculations.calculateProjectDuration(project);
  }
}
```

### Dates
```typescript
// ‚úÖ Use dateCalculations
import { normalizeToMidnight, addDaysToDate } from '@/services';

// ‚ùå Never manual
date.setHours(0, 0, 0, 0);
new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
```

### Error Handling
```typescript
// ‚úÖ Use ErrorHandlingService
ErrorHandlingService.handle(error, {
  source: 'ProjectModal',
  action: 'saveProject',
  metadata: { projectId: project.id }
}, { showToast: true });

// ‚ùå Never
console.error('Error:', error);
```

### Types
```typescript
// ‚úÖ Extend core.ts
import { Project } from '@/types/core';
interface LocalProject extends Project { temp?: boolean; }

// ‚ùå Never redefine
interface Project { id: string; }
```

---

## 5. BUSINESS LOGIC CHANGES

When modifying business rules:

1. **Update `docs/core/App Logic.md`** (entity definitions, workflows, validation summary)
2. **Update `docs/core/Business Logic.md`** (detailed rules, calculations, edge cases)
3. **Update `src/domain/rules/*.ts`** (with `@see` references)
4. **Update orchestrators** (workflows using the rule)
5. **Update tests**
6. **Commit with `logic:` prefix**

### Document Ownership

| Change Type | Update App Logic | Update Business Logic |
|-------------|------------------|----------------------|
| New entity or property | ‚úÖ Yes | ‚úÖ Yes (TypeScript interface) |
| New validation rule | ‚úÖ Yes (summary table) | ‚úÖ Yes (detailed logic) |
| New workflow | ‚úÖ Yes | ‚ùå No |
| Calculation formula | ‚ùå No | ‚úÖ Yes |
| Edge case handling | ‚ùå No | ‚úÖ Yes |
| State transition | ‚ùå No | ‚úÖ Yes |

### What Requires Doc Updates
‚úÖ Validation rules, calculations, entities, relationships, [CLARIFY] decisions

### What Doesn't
‚ùå UI changes, performance optimizations, bug fixes, refactoring, tests

---

## 6. DOCUMENTATION

| Folder | Purpose | Action |
|--------|---------|--------|
| `/docs/core/` | Framework (3 files) | UPDATE existing only |
| `/docs/features/[name]/` | Feature docs | Permanent |
| `/docs/operations/` | Testing, deployment | Permanent |
| `/docs/sessions/` | **TEMPORARY** | AI working docs |

### AI Rules
1. ‚ùå Don't create docs in `/docs/` root or `/docs/features/`
2. ‚úÖ Create temporary docs in `/docs/sessions/`
3. ‚úÖ Update existing core docs when logic changes
4. ‚úÖ Remind user to delete `/docs/sessions/` files when done

---

## 7. HOOKS

### When to Create
- Managing React state with service coordination
- Handling DOM events (drag, scroll, resize)
- Coordinating services with React lifecycle
- Cleaning up side effects

### Never Put in Hooks
- ‚ùå Business logic ‚Üí `domain/rules`
- ‚ùå Calculations ‚Üí `services/unified`
- ‚ùå Workflows ‚Üí `services/orchestrators`
- ‚ùå Database operations ‚Üí orchestrators

> **Note:** Creating hooks does NOT require changing existing services. Services remain pure and stateless.

### Pattern
```typescript
// ‚úÖ Hook coordinates services + manages state
export function useProjectDrag(config) {
  const [isDragging, setIsDragging] = useState(false);
  
  const handleMouseDown = useCallback((e, projectId) => {
    const result = TimelineDragCoordinatorService.coordinateDragOperation(dragState, e);
    setDragState(result.newDragState);
  }, [config]);
  
  return { isDragging, handleMouseDown };
}
```

---

## 8. TYPOGRAPHY

All text colors use CSS variables in `index.css`. **Never hardcode colors.**

| CSS Variable | Usage | Tailwind Class |
|--------------|-------|----------------|
| `--foreground` | Primary text | `text-foreground` |
| `--foreground-secondary` | Secondary text | `text-muted-foreground` |
| `--foreground-tertiary` | Tertiary text | `text-gray-500` |

```typescript
// ‚úÖ Use semantic classes
<div className="text-foreground">Primary</div>
<div className="text-muted-foreground">Secondary</div>

// ‚ùå Never hardcode
<div className="text-[#595956]">Text</div>
```

### To Change App-Wide Text Color
Update `--foreground` in `src/index.css` - all derived variables update automatically.

---

## 9. CHECKLIST

Before committing:
- [ ] Checked for existing similar code? (`grep -r`)
- [ ] Importing from `@/services`?
- [ ] Using `core.ts` types?
- [ ] Using `dateCalculations` for dates?
- [ ] Using `ErrorHandlingService` for errors?
- [ ] Unified services delegating to domain layer?
- [ ] Business logic in services, not components?
- [ ] If logic changed: updated App_Logic.md + Business_Logic.md?
- [ ] Commit message has correct prefix?
