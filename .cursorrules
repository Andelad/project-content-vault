# üö® AI Development Guide

> **Note:** This file is named `.cursorrules` for compatibility with AI development tools that auto-detect it. It applies to ALL AI assistants (Cursor, Copilot, Claude, etc.), not just Cursor IDE.

> **Philosophy:** "Find existing, extend existing, create new only when necessary"

---

## üìö DOCUMENTATION GUIDE

| Document | When to Read | Contains |
|----------|--------------|----------|
| **`docs/core/App Logic.md`** | Understanding WHAT (domain concepts) | Entity definitions, time concepts, workflows (UI-agnostic) |
| **`docs/core/Business Logic.md`** | Understanding HOW (domain rules) | Calculations, validation formulas, edge cases (UI-agnostic) |
| **`docs/core/View Specifications.md`** | Understanding UI constraints | Display rules, view-specific behavior, visual styling |
| **`docs/core/Architecture Guide.md`** | Understanding WHERE code goes | Hybrid DDD approach, code structure, patterns |

**Quick Reference:**
- "What is a Phase?" ‚Üí App Logic.md
- "How do auto-estimates calculate?" ‚Üí Business Logic.md
- "Why can't Timeline show overlapping bars?" ‚Üí View Specifications.md
- "Where should I put this code?" ‚Üí Architecture Guide.md
- "Can orchestrators mix concerns?" ‚Üí Architecture Guide.md (yes, by design)

**Document Ownership:**

| Concept | Owner |
|---------|-------|
| Domain entities & rules | App Logic.md (concepts) + Business Logic.md (formulas) |
| UI display constraints | View Specifications.md |
| Code patterns | Architecture Guide.md |
| Feature implementation | Code itself (`src/components/features/`) |

**Building Features:**
1. Read App Logic.md + Business Logic.md for domain truth
2. Read View Specifications.md for UI-specific constraints
3. Check Architecture Guide.md for code organization
4. Explore `src/components/features/` for patterns

---

## 1. QUICK REFERENCE

### Never Create
- ‚ùå `/helpers/` directories
- ‚ùå Business logic in `/utils/` or components
- ‚ùå Calculations in components
- ‚ùå Duplicate types (use `/types/core.ts`)
- ‚ùå Manual date math
- ‚ùå Validator wrapper files (call domain rules directly)
- ‚ùå Repository wrapper files (call Supabase directly, except `timeTrackingRepository`)
- ‚ùå Domain/business logic in orchestrators (put in `domain/rules/`)

### Always Use
- ‚úÖ Import from `@/services` only
- ‚úÖ Types from `/types/core.ts`
- ‚úÖ Domain rules from `/domain/rules/` for validation & business logic
- ‚úÖ Domain entities from `/domain/entities/` (Phase 2 - gradual adoption)
- ‚úÖ `dateCalculations.ts` for all date operations
- ‚úÖ `ErrorHandlingService` for all errors
- ‚úÖ Find existing unified services first
- ‚úÖ Delegation pattern in unified services

### Before Writing Code
```bash
grep -r "functionName" src/services/
ls src/services/unified/ | grep -i "domain"
```

---

## 2. CODE ORGANIZATION

**Architecture: Hybrid DDD** (see Architecture Guide.md for details)

| Code Type | Location | Purity | Example |
|-----------|----------|--------|---------|
| **Domain Rules** | `/domain/rules/*Rules` | 100% pure (no UI/DB) | Validation, business logic |
| **Domain Entities** | `/domain/entities/*` | 100% pure (no UI/DB) | Rich objects (Phase 2 adoption) |
| **Orchestrators** | `/services/orchestrators/*Orchestrator` | Mixed (by design) | Workflows: validation + DB + UI prep |
| **Unified Services** | `/services/unified/Unified*Service` | Pure calculations | Business calculations |
| **UI Components** | `/components` | UI only | Call services, no logic |
| Date Math | `/services/calculations/general/dateCalculations` | Pure math | `normalizeToMidnight()` |
| Error Handling | `ErrorHandlingService` | Infrastructure | Structured logging |
| React State | `/hooks/use*.ts` | Coordination | State + service calls |
| Generic Utils | `/utils` or `/lib` | Pure helpers | `cn()`, `formatCurrency()` |

**Orchestrator Scope (Hybrid DDD - Mixed by Design):**
- ‚úÖ Call domain rules (`ProjectRules.validate()`)
- ‚úÖ Call Supabase directly (no repository layer)
- ‚úÖ Transform data for database
- ‚úÖ Enrich data for UI display
- ‚úÖ Coordinate workflows & side effects
- ‚ùå NEVER implement business rules (use `domain/rules/`)
- ‚ùå NEVER implement calculations (use `unified/` services)

---

## 3. DEVELOPMENT WORKFLOW (VS Code ‚Üî Lovable ‚Üî Supabase)

| Tool | Purpose |
|------|---------|
| **VS Code** | TypeScript, React, business logic |
| **Lovable** | Database migrations, Supabase schema |
| **GitHub** | Sync point between both |

### For Database Changes
1. ‚ùå **DO NOT** run SQL migrations directly
2. ‚úÖ Create `INSTRUCTIONS_FOR_LOVABLE_[FEATURE].md` in project root
3. ‚úÖ Include SQL, purpose, and verification steps
4. ‚úÖ Push to GitHub for Lovable to execute

---

## 4. PATTERNS

### Orchestrators (workflows)
```typescript
// ‚úÖ Orchestrators coordinate & mix concerns (by design)
export class ProjectOrchestrator {
  static async executeProjectCreationWorkflow(request, context) {
    // ‚úÖ Call domain rules (pure validation)
    const validation = ProjectRules.validateProjectDates(request.startDate, request.endDate);
    if (!validation.isValid) return { success: false, errors: validation.errors };
    
    // ‚úÖ Transform for DB (allowed)
    const prepared = this.transformForDatabase(request);
    
    // ‚úÖ Direct Supabase (no repository layer)
    const { data, error } = await supabase.from('projects').insert(prepared).select().single();
    
    // ‚úÖ Enrich for UI (allowed)
    return this.enrichForDisplay(data);
  }
  
  // ‚ùå FORBIDDEN - business logic belongs in domain/rules/
  // private calculateRemainingHours() { ... }
}
```

### Unified Services (calculations)
```typescript
// ‚úÖ Always delegate to domain layer
export class UnifiedProjectService {
  static calculateDuration(project: Project): number {
    return DateCalculations.calculateProjectDuration(project);
  }
}
```

### Dates
```typescript
// ‚úÖ Use dateCalculations
import { normalizeToMidnight, addDaysToDate } from '@/services';

// ‚ùå Never manual
date.setHours(0, 0, 0, 0);
new Date(today.getTime() + 7 * 24 * 60 * 60 * 1000);
```

### Error Handling
```typescript
// ‚úÖ Use ErrorHandlingService
ErrorHandlingService.handle(error, {
  source: 'ProjectModal',
  action: 'saveProject',
  metadata: { projectId: project.id }
}, { showToast: true });

// ‚ùå Never
console.error('Error:', error);
```

### Types
```typescript
// ‚úÖ Extend core.ts
import { Project } from '@/types/core';
interface LocalProject extends Project { temp?: boolean; }

// ‚ùå Never redefine
interface Project { id: string; }
```

---

## 5. BUSINESS LOGIC CHANGES

When modifying business rules:

1. **Update `docs/core/App Logic.md`** (entity definitions, domain concepts - UI-agnostic)
2. **Update `docs/core/Business Logic.md`** (detailed rules, calculations - UI-agnostic)
3. **Update `docs/core/View Specifications.md`** (if UI-specific display rules changed)
4. **Update `src/domain/rules/*.ts`** (with `@see` references)
5. **Update orchestrators** (workflows using the rule)
6. **Update tests**
7. **Commit with `logic:` prefix**

### Document Ownership

| Change Type | App Logic | Business Logic | View Specs |
|-------------|-----------|----------------|------------|
| New entity/property | ‚úÖ Yes | ‚úÖ Yes (TS interface) | ‚ùå No |
| Domain validation rule | ‚úÖ Yes (summary) | ‚úÖ Yes (detailed) | ‚ùå No |
| Calculation formula | ‚ùå No | ‚úÖ Yes | ‚ùå No |
| UI display constraint | ‚ùå No | ‚ùå No | ‚úÖ Yes |
| New workflow | ‚úÖ Yes | ‚ùå No | ‚ùå No |

### What Requires Doc Updates
‚úÖ Validation rules, calculations, entities, relationships, UI display constraints

### What Doesn't
‚ùå Bug fixes, refactoring, tests, performance optimizations

---

## 6. DOCUMENTATION

| Folder | Purpose | Action |
|--------|---------|--------|
| `/docs/core/` | Framework (3 files) | UPDATE existing only |
| `/docs/features/[name]/` | Feature docs | Permanent |
| `/docs/operations/` | Testing, deployment | Permanent |
| `/docs/sessions/` | **TEMPORARY** | AI working docs |

### AI Rules
1. ‚ùå Don't create docs in `/docs/` root or `/docs/features/`
2. ‚úÖ Create temporary docs in `/docs/sessions/`
3. ‚úÖ Update existing core docs when logic changes
4. ‚úÖ Remind user to delete `/docs/sessions/` files when done

---

## 7. HOOKS

### When to Create
- Managing React state with service coordination
- Handling DOM events (drag, scroll, resize)
- Coordinating services with React lifecycle
- Cleaning up side effects

### Never Put in Hooks
- ‚ùå Business logic ‚Üí `domain/rules`
- ‚ùå Calculations ‚Üí `services/unified`
- ‚ùå Workflows ‚Üí `services/orchestrators`
- ‚ùå Database operations ‚Üí orchestrators

> **Note:** Creating hooks does NOT require changing existing services. Services remain pure and stateless.

### Pattern
```typescript
// ‚úÖ Hook coordinates services + manages state
export function useProjectDrag(config) {
  const [isDragging, setIsDragging] = useState(false);
  
  const handleMouseDown = useCallback((e, projectId) => {
    const result = TimelineDragCoordinatorService.coordinateDragOperation(dragState, e);
    setDragState(result.newDragState);
  }, [config]);
  
  return { isDragging, handleMouseDown };
}
```

---

## 8. TYPOGRAPHY

All text colors use CSS variables in `index.css`. **Never hardcode colors.**

| CSS Variable | Usage | Tailwind Class |
|--------------|-------|----------------|
| `--foreground` | Primary text | `text-foreground` |
| `--foreground-secondary` | Secondary text | `text-muted-foreground` |
| `--foreground-tertiary` | Tertiary text | `text-gray-500` |

```typescript
// ‚úÖ Use semantic classes
<div className="text-foreground">Primary</div>
<div className="text-muted-foreground">Secondary</div>

// ‚ùå Never hardcode
<div className="text-[#595956]">Text</div>
```

### To Change App-Wide Text Color
Update `--foreground` in `src/index.css` - all derived variables update automatically.

---

## 9. CHECKLIST

Before committing:
- [ ] Checked for existing similar code? (`grep -r`)
- [ ] Importing from `@/services`?
- [ ] Using `core.ts` types?
- [ ] Using `dateCalculations` for dates?
- [ ] Using `ErrorHandlingService` for errors?
- [ ] Domain rules in `domain/rules/`, not orchestrators?
- [ ] Orchestrators coordinate only (no business logic)?
- [ ] Business logic in services, not components?
- [ ] If domain logic changed: updated App Logic.md + Business Logic.md?
- [ ] If UI constraint changed: updated View Specifications.md?
- [ ] Commit message has correct prefix?
